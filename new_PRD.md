

## 用户故事（调整后）

- 角色：数据分析者/业务同事，需要在对话式分析前快速把数据准备好。
- 目标：先登记“数据对象”（库表/文件），再组合成“数据源”并在分析会话中选择使用。
- 故事：用户登录 → 在“数据对象”中新建并预览 raw 对象 → 在“数据源管理”创建数据源、挑选 raw 并做字段对齐 → 在分析会话侧边栏选择数据源开始提问。

## 端到端流程（数据对象→数据源→分析）
1. 配置数据对象：新建 raw（库表或文件），填写连接/上传信息，点击预览抽样，命名并可修正类型。
2. 构建数据源：在“数据源管理”创建数据源，填名称/描述/类型，勾选关联 raw，对每个 raw 配置字段映射，预览合并后的结果，保存。
3. 分析会话：进入对话页，选择一个或多个数据源作为上下文，开始分析；可随时切换或追加数据源，聊天窗口展示所用数据源标签。

## 当前实现（基于现有代码）
- 数据源：仅支持“数据库/文件直连”两类数据源；创建/列表/更新/删除、连接测试、schema 同步缓存（DB 提取或文件列信息）。
- 文件资产：上传文件到对象存储，查看详情、分页列表、预览前几行、生成下载链接，用于文件型数据源。
- 会话：创建会话时选择 data_source_ids；会话详情返回关联数据源；支持更新/删除/归档。
- 会话文件：在会话目录上传临时文件到沙盒，列出/下载沙盒中的结果文件（查询缓存、图表等）。
- 对话：SSE 流式 Chat，支持文本流 + 工具调用/结果，工具包含 execute_sql、execute_python、quick_analysis、generate_chart 等。
- 任务推荐：基于会话及数据源 schema 生成初始推荐，或根据上下文生成追问推荐，状态可更新。
- 沙盒：独立 FastAPI 服务，提供文件上传/下载、DuckDB SQL、Python 执行、quick_analysis、生成图表等接口。

## 差距与待办（对齐 PRD）
- 缺少“数据对象 raw”层：需要新增 raw 创建/预览/管理，缓存抽样 schema。
- 数据源未基于 raw 聚合与字段映射：现状为直连 DB/文件；需引入 raw_ids、target_fields、per-raw 映射与合并预览。
- 会话侧未暴露 raw+映射信息：需在数据源详情、会话详情中返回映射后的 schema/标签，便于前端显示与 Agent 使用。
- 迁移与兼容：需要 Alembic 迁移新增 raw 表、为历史 data_source 回填 raw 记录与默认映射，保留旧直连字段兼容。
- 前端：需新增“数据对象”页与“数据源编辑器（字段对齐+预览）”，会话侧数据源选择需展示映射后的逻辑字段。

## 前端怎么做

### 步骤 1：配置数据对象

页面可以叫「数据对象」或「数据对象」。

**1）创建数据对象对象**

用户操作流程：

1. 点击“新建数据对象”；
2. 选择类型：
   - 数据库表（Postgres/MySQL/…）
   - 文件（本地/S3/http）
3. 填必要信息：
   - 如果是 DB：
     - 先选一个已配置好的连接（你前面做的“连接管理”）
     - 再选 schema + table，或者自填 SQL（可选）
   - 如果是文件：
     上传到minio

4. 点击“预览”：
   - 前端调用后端 `/preview-raw`，后端用 DuckDB 抽样 N 行；
   - 展示列名、推断的类型、样例数据。

5. 用户可以：
   - 给这个数据对象起一个名字（逻辑名），比如 `pg_orders_raw`、`s3_events_raw`；
   - 对个别字段类型做修正（例如把 `VARCHAR` 改为 `TIMESTAMP`）。



> 这一层不做“业务建模”，只要把原始结构描述出来即可。

---

### 步骤 2：基于数据对象构建“数据源”

这一步就是你说的「基于数据对象构建数据源」。  
可以设计成一个配置页面：`数据源管理`。

**1）新建数据源**

属性：

- 名字：比如 `OrdersSource`
- 描述：比如“订单相关的统一入口，包含 PG 和 CSV 两部分”
- 类型（可选）：事实类 / 维度类 / 事件类；仅用于分类和提示

**2）选择要纳入的数据对象**

- 左侧列表：所有数据对象（raw）。
- 用户把关联的 raw 拖进来/勾选：
  - `pg_orders_raw` + `csv_orders_raw`

**3）配置字段统一（轻量，而不是复杂建模）**

你可以设计一个很简单的“字段对齐”界面：

- 右侧有一个“数据源字段列表”（目标字段），例如：
  - `order_id`
  - `customer_id`
  - `order_time`
  - `amount`
  - `discount`
- 对每个 raw 对象，指定它的字段如何映射到这些目标字段：

示例映射：

- 对 `pg_orders_raw`：
  - `order_id` ← `id`
  - `customer_id` ← `customer_id`
  - `order_time` ← `created_at`
  - `amount` ← `total`
  - `discount` ← [空]（默认填 NULL）

- 对 `csv_orders_raw`：
  - `order_id` ← `order_id`
  - `customer_id` ← `user_id`
  - `order_time` ← `order_time`
  - `amount` ← `amount`
  - `discount` ← `discount`



## 页面/交互草稿

### 数据对象配置页
- 入口：导航“数据源管理”下的“数据对象”页；按钮“新建数据对象”。
- 表单：类型（库表/文件）、连接选择或文件上传、schema+table/SQL 或文件格式参数。
- 动作：预览调用 `/preview-raw` 抽样；结果区显示列名/推断类型/示例，允许单列类型修正；保存生成 raw 名称。

### 数据源管理/编辑器
- 列表：展示现有数据源（名称、描述、类型、使用的 raw、状态）。
- 新建/编辑：填写名称/描述/类型；左侧 raw 列表多选；右侧“目标字段”列表可添加/重命名。
- 字段对齐：对每个 raw 映射到目标字段，支持下拉选择或手填表达式；未映射默认 NULL；提供快捷复制上一份映射。
- 预览：基于映射展示合并后的示例数据；保存后返回列表。

### 分析会话选择数据源
- 会话侧栏：数据源选择器（可多选），展示已选标签和状态。
- 选择后：聊天提示当前数据源上下文；可随时切换/追加数据源；切换会提示上下文变更。
- 当无数据源时：引导去“数据源管理”创建，提供跳转。

## 这样做的优点


   - 步骤简单清晰：
     1. 配数据对象（怎么连、在哪里、长什么样）
     2. 用数据对象组合“数据源”（给 AI 用的入口）

2. **不强迫用户懂“数仓建模”**

   - 用户只需要知道：
     - 什么数据要分析（订单、用户、事件…）
     - 这些数据在哪里（在哪个库 / 哪个文件）
   - 数据源就是“给某个主题起的一个逻辑名字 + 字段对齐规则”。

3. **对 AI 友好**

   - AI 面前是有限数量的、名字清晰的数据源；
   - 不被一堆 raw 表 / 文件名淹没；
   - 字段语义在“数据源层”已经统一（`user_id` vs `customer_id` 等）。

4. **前端复杂度可控**

   - 不搞复杂的 star schema / 维度建模工具；
   - 只需要做：
     - 数据对象配置页；
     - 简单的“数据源编辑器”：选 raw + 字段映射 + 预览。

